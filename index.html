<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íƒœì–‘ê³„ í–‰ì„± í•©ì¹˜ê¸° ê²Œì„</title>
    <!-- Tone.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* CSS styles for the game */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a4a 30%, #2d1b69 70%, #4a0e5e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            font-size: 16px;
            touch-action: manipulation; /* í„°ì¹˜ ì•¡ì…˜ ê¸°ë³¸ ë™ì‘ ë°©ì§€ */
            -webkit-touch-callout: none; /* iOSì—ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ ë©”ë‰´ ë‚˜íƒ€ë‚˜ëŠ” ê²ƒ ë°©ì§€ */
            -webkit-user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            animation: cosmicPulse 10s ease-in-out infinite;
            margin: 0;
            padding: 0;
        }

        @keyframes cosmicPulse {
            0%, 100% { background: linear-gradient(135deg, #0a0a1a 0%, #1a1a4a 30%, #2d1b69 70%, #4a0e5e 100%); }
            50% { background: linear-gradient(135deg, #1a0a2a 0%, #2a1a5a 30%, #3d2b79 70%, #5a1e6e 100%); }
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: linear-gradient(45deg, transparent, #fff, transparent);
            border-radius: 50%;
            animation: shootingStar 4s linear infinite;
        }

        @keyframes shootingStar {
            0% {
                transform: translateX(-100vw) translateY(100vh);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw) translateY(-100vh);
                opacity: 0;
            }
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .nebula {
            position: fixed;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            animation: floatNebula 20s ease-in-out infinite;
        }

        .nebula:nth-child(1) {
            background: radial-gradient(circle, rgba(255, 107, 53, 0.1) 0%, transparent 70%);
            top: 10%;
            left: 10%;
        }

        .nebula:nth-child(2) {
            background: radial-gradient(circle, rgba(74, 144, 226, 0.1) 0%, transparent 70%);
            top: 60%;
            right: 10%;
            animation-delay: -10s;
        }

        @keyframes floatNebula {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20px, -30px) scale(1.1); }
            66% { transform: translate(-20px, -10px) scale(0.9); }
        }
        
        h1 {
            margin: 20px 0;
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { 
                background-position: 0% 50%;
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
            50% { 
                background-position: 100% 50%;
                text-shadow: 0 0 40px rgba(255, 107, 53, 0.9);
            }
        }
        
        .main-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2rem;
            width: 95%;
            max-width: 1200px;
            margin: 0;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .right-column {
            flex: 1;
        }

        .game-info {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        
        .score, .next-planet {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1.25rem;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .game-container {
            position: relative;
            border: 3px solid #4a90e2;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 
                0 0 40px rgba(74, 144, 226, 0.6),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 4 / 6; /* ìº”ë²„ìŠ¤ ë¹„ìœ¨ ìœ ì§€ */
        }
        
        #gameCanvas {
            display: block;
            background: transparent;
            width: 100%;
            height: 100%;
            cursor: pointer;
            touch-action: none; /* ìº”ë²„ìŠ¤ ë‚´ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .controls {
            margin-top: 1.5rem;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }
        
        button {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.6);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        .planet-guide {
            margin-top: 0;
            text-align: center;
            opacity: 0.9;
            max-width: 500px;
            line-height: 1.5;
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .planet-guide h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .planet-guide p {
            margin-bottom: 0.5rem;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
        }
        
        .game-over h2 {
            color: #ff6b35;
            margin-bottom: 1rem;
            font-size: 2rem;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        .ranking {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            margin-top: 1rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .ranking h3 {
            text-align: center;
            margin-bottom: 1rem;
            color: #ffd700;
            font-size: 1.3rem;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .ranking-table {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .ranking-table th, .ranking-table td {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .ranking-table thead th {
            background-color: rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        .ranking-table tbody tr.new-record {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.5);
            animation: recordGlow 2s ease-in-out infinite alternate;
        }

        @keyframes recordGlow {
            from { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        .rank-number {
            font-weight: bold;
            color: #4a90e2;
        }

        .rank-score {
            font-weight: bold;
            color: #ffd700;
        }

        .rank-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .no-records {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            padding: 2rem;
        }

        .guide-table {
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: left;
        }
        
        .guide-table th, .guide-table td {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .guide-table thead th {
            background-color: rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        .power-up {
            position: absolute;
            font-size: 20px;
            pointer-events: none;
            z-index: 100;
            animation: powerUpFloat 2s ease-out forwards;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        @keyframes powerUpFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        .achievements {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 10px;
            display: none;
            z-index: 1001;
            border: 2px solid rgba(255, 215, 0, 0.5);
            animation: achievementSlide 3s ease-in-out forwards; /* forwards ì¶”ê°€ */
        }

        @keyframes achievementSlide {
            0% { transform: translateX(100%); opacity: 0; }
            15%, 85% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .achievement-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .achievement-icon {
            font-size: 2em;
        }

        .achievement-text {
            color: #ffd700;
            font-weight: bold;
        }
        
        /* ëª¨ë°”ì¼ í™˜ê²½ì„ ìœ„í•œ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 900px) {
            h1 { font-size: 2rem; }
            .main-content-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 1.5rem;
                margin: 0;
            }
            .left-column, .right-column {
                width: 95%;
            }
            .game-info {
                font-size: 1rem;
                margin-bottom: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            .controls {
                margin-top: 1rem;
            }
            button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .planet-guide {
                margin-top: 1rem;
                padding: 1rem;
            }
            .achievements {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- ì¹´ì¹´ì˜¤ ê´‘ê³  ì‚½ì… -->
    <ins class="kakao_ad_area"
    data-ad-unit = "DAN-BvMndTGf4NHqUegB"
    data-ad-width = "320"
    data-ad-height = "100"></ins>
    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
    <ins class="kakao_ad_area" style="display:none;"
data-ad-unit = "DAN-2tN20MdEUXO9gLYv"
data-ad-width = "160"
data-ad-height = "600"></ins>
<script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
    
    <div class="stars" id="stars"></div>
    <div class="nebula"></div>
    <div class="nebula"></div>
    
    
    <h1>ğŸŒŸ íƒœì–‘ê³„ í–‰ì„± í•©ì¹˜ê¸° ğŸŒŒ</h1>
    
    <div class="achievements" id="achievements">
        <div class="achievement-content">
            <div class="achievement-icon" id="achievementIcon">ğŸ†</div>
            <div class="achievement-text" id="achievementText">ë‹¬ì„±!</div>
        </div>
    </div>
    
    <div class="main-content-wrapper">
        <div class="left-column">
            <div class="game-info">
                <div class="score">ì ìˆ˜: <span id="score">0</span></div>
                <div class="next-planet">ë‹¤ìŒ: <span id="nextPlanet">âš«</span></div>
            </div>
            
            <div class="game-container">
                <canvas id="gameCanvas"></canvas>
                <!-- ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤„ div -->
                <div class="game-over" id="gameOverModal">
                    <h2 id="gameOverTitle">ê²Œì„ ì˜¤ë²„!</h2>
                    <p>ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></p>
                    <button onclick="restartGame()">ìƒˆ ê²Œì„</button>
                </div>
            </div>
            
            <div class="controls">
                <!-- "í–‰ì„± ë–¨ì–´ëœ¨ë¦¬ê¸°" ë²„íŠ¼ ì œê±°ë¨ -->
                <button onclick="restartGame()">ìƒˆ ê²Œì„</button>
                <!-- ì‚¬ìš´ë“œ í† ê¸€ ë²„íŠ¼ ì¶”ê°€ -->
                <button id="soundToggleButton" onclick="toggleMute()">ğŸµ ì‚¬ìš´ë“œ ì¼œê¸°</button>
            </div>
        </div>
        
        <div class="right-column">
            <div class="ranking">
                <h3>ğŸ† ìµœê³  ê¸°ë¡</h3>
                <div id="rankingContainer">
                    <div class="no-records">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
                <div style="margin-top: 1rem;">
                    <button onclick="clearRankings()" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">ê¸°ë¡ ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="planet-guide">
                <h3 style="margin-bottom: 10px;">ğŸš€ ì§„í™” ìˆœì„œ (ì§€êµ¬ ëŒ€ë¹„ í¬ê¸° ìˆœ)</h3>
                <table class="guide-table">
                    <thead>
                        <tr>
                            <th>ìˆœì„œ</th>
                            <th>í–‰ì„±</th>
                            <th>ì§€êµ¬ ëŒ€ë¹„ í¬ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>âš« ì„¸ë ˆìŠ¤</td><td>ì•½ 0.08ë°°</td></tr>
                        <tr><td>2</td><td>ğŸ§Š ëª…ì™•ì„±</td><td>ì•½ 0.18ë°°</td></tr>
                        <tr><td>3</td><td>ğŸ’ íŠ¸ë¦¬í†¤</td><td>ì•½ 0.21ë°°</td></tr>
                        <tr><td>4</td><td>ğŸŒ• ë‹¬</td><td>ì•½ 0.27ë°°</td></tr>
                        <tr><td>5</td><td>âšª ìˆ˜ì„±</td><td>ì•½ 0.38ë°°</td></tr>
                        <tr><td>6</td><td>ğŸ”´ í™”ì„±</td><td>ì•½ 0.53ë°°</td></tr>
                        <tr><td>7</td><td>ğŸŸ¡ ê¸ˆì„±</td><td>ì•½ 0.95ë°°</td></tr>
                        <tr><td>8</td><td>ğŸŒ ì§€êµ¬</td><td>ì•½ 1.00ë°°</td></tr>
                        <tr><td>9</td><td>ğŸ”µ í•´ì™•ì„±</td><td>ì•½ 3.88ë°°</td></tr>
                        <tr><td>10</td><td>ğŸ”® ì²œì™•ì„±</td><td>ì•½ 4.01ë°°</td></tr>
                        <tr><td>11</td><td>ğŸª í† ì„±</td><td>ì•½ 9.45ë°°</td></tr>
                        <tr><td>12</td><td>ğŸŒ€ ëª©ì„±</td><td>ì•½ 11.2ë°°</td></tr>
                        <tr><td>13</td><td>â˜€ï¸ íƒœì–‘</td><td>ì•½ 109ë°°</td></tr>
                    </tbody>
                </table>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                    <p>ğŸ¯ <strong>ëª©í‘œ:</strong> íƒœì–‘ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // ----- ê¸°ë³¸ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° -----
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameContainer = document.querySelector('.game-container'); // ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ
    const gameOverModal = document.getElementById('gameOverModal');
    const gameOverTitle = document.getElementById('gameOverTitle');
    const finalScore = document.getElementById('finalScore');
    const scoreElement = document.getElementById('score');
    const nextPlanetElement = document.getElementById('nextPlanet');
    const achievementsElement = document.getElementById('achievements');
    const achievementIcon = document.getElementById('achievementIcon');
    const achievementText = document.getElementById('achievementText');
    const rankingContainer = document.getElementById('rankingContainer');
    const soundToggleButton = document.getElementById('soundToggleButton');

    // ----- ê²Œì„ ì„¤ì • ë° ìƒíƒœ ë³€ìˆ˜ -----
    let score = 0;
    let gameRunning = true;
    let dropX = 0; // ë§ˆì§€ë§‰ ì„¤ì •ëœ ë“œë¡­ ìœ„ì¹˜
    let planets = [];
    let currentPlanet = null; // í˜„ì¬ ë–¨ì–´ëœ¨ë¦´ í–‰ì„±
    let nextPlanetType = 0; // ë‹¤ìŒ í–‰ì„± íƒ€ì…
    let rankings = []; // ë­í‚¹ ë°ì´í„° ì €ì¥
    let achievementsUnlocked = {}; // ë‹¬ì„±í•œ ì—…ì  ì €ì¥
    let powerUps = []; // ì ìˆ˜ í‘œì‹œ í…ìŠ¤íŠ¸ ë“± ì¼ì‹œì ì¸ íš¨ê³¼ ê´€ë¦¬
    
    // ê²Œì„ ì˜¤ë²„ ë¼ì¸ (ìº”ë²„ìŠ¤ ìƒë‹¨ì—ì„œ Yì¶• ìœ„ì¹˜)
    const gameOverLineY = 80;
    let gameOverStartTime = null; // ê²Œì„ì˜¤ë²„ ì¡°ê±´ ì‹œì‘ ì‹œê°„ 
    const gameOverDelay = 3000; // 3ì´ˆ ë™ì•ˆ í–‰ì„±ì´ ë¼ì¸ ìœ„ì— ìˆìœ¼ë©´ ê²Œì„ ì˜¤ë²„ (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ 3ì´ˆë¡œ ë³µêµ¬)

    // ë¬¼ë¦¬ ìƒìˆ˜ë“¤
    const GRAVITY = 0.45; // ì¤‘ë ¥ -> 0.35ì—ì„œ 0.45ë¡œ ì¦ê°€ (ë” ë¹ ë¥´ê²Œ ë–¨ì–´ì§)
    const AIR_RESISTANCE = 1.0; // ê³µê¸° ì €í•­ (1.0ì€ ì €í•­ ì—†ìŒ)
    const GROUND_FRICTION = 0.9; // ë°”ë‹¥ ë§ˆì°°ì„ ë†’ì—¬ ìˆ˜í‰ ì´ë™ì„ ì¤„ì„ (ìœ ì§€)
    const BOUNCE_DAMPING = 0.001; // íŠ•ê¹€ ê°ì‡ ë¥¼ ë” ë†’ì—¬ ì¶©ëŒ ì‹œ ì†ë„ ì†ì‹¤ì„ ëŠ˜ë¦¼ (ë” ì ê²Œ íŠ•ê¸°ë„ë¡) -> 0.005ì—ì„œ 0.001ë¡œ ê°ì†Œ
    const MIN_VELOCITY_THRESHOLD = 1.0; // ìµœì†Œ ì†ë„ ì„ê³„ê°’ (ë” ë¹¨ë¦¬ ë©ˆì¶”ë„ë¡) -> 0.8ì—ì„œ 1.0ìœ¼ë¡œ ì¦ê°€
    const SLEEP_THRESHOLD = 1.0; // ìˆ˜ë©´ ì„ê³„ê°’ (ë” ë¹¨ë¦¬ ìˆ˜ë©´ ëª¨ë“œ ì§„ì…í•˜ë„ë¡) -> 0.8ì—ì„œ 1.0ìœ¼ë¡œ ì¦ê°€

    // ----- í–‰ì„± ë°ì´í„° (fontSize ìˆ˜ì •ë¨) -----
    const planetTypes = [
        { size: 15, emoji: 'âš«', name: 'ì„¸ë ˆìŠ¤', points: 1, fontSize: 33, color: '#666666' },
        { size: 18, emoji: 'ğŸ§Š', name: 'ëª…ì™•ì„±', points: 2, fontSize: 40, color: '#87ceeb' },
        { size: 21, emoji: 'ğŸ’', name: 'íŠ¸ë¦¬í†¤', points: 3, fontSize: 46, color: '#b0e0e6' },
        { size: 24, emoji: 'ğŸŒ•', name: 'ë‹¬', points: 4, fontSize: 53, color: '#f5f5dc' },
        { size: 27, emoji: 'âšª', name: 'ìˆ˜ì„±', points: 5, fontSize: 60, color: '#c0c0c0' },
        { size: 33, emoji: 'ğŸ”´', name: 'í™”ì„±', points: 6, fontSize: 73, color: '#cd5c5c' },
        { size: 42, emoji: 'ğŸŸ¡', name: 'ê¸ˆì„±', points: 8, fontSize: 92, color: '#ffd700' },
        { size: 45, emoji: 'ğŸŒ', name: 'ì§€êµ¬', points: 10, fontSize: 99, color: '#4169e1' },
        { size: 75, emoji: 'ğŸ”µ', name: 'í•´ì™•ì„±', points: 20, fontSize: 165, color: '#4169e1' },
        { size: 78, emoji: 'ğŸ”®', name: 'ì²œì™•ì„±', points: 25, fontSize: 172, color: '#40e0d0' },
        { size: 97.5, emoji: 'ğŸª', name: 'í† ì„±', points: 30, fontSize: 215, color: '#fad5a5' },
        { size: 112.5, emoji: 'ğŸŒ€', name: 'ëª©ì„±', points: 50, fontSize: 248, color: '#daa520' },
        { size: 150, emoji: 'â˜€ï¸', points: 100, fontSize: 330, color: '#ffa500' }
    ];

    // ì—…ì  ì •ì˜ (ì½¤ë³´ ì—…ì  ì œê±°)
    const achievementDefinitions = [
        { id: 'first_merge', name: 'ì²« í•©ì²´', description: 'ì²« ë²ˆì§¸ í–‰ì„± í•©ì²´', icon: 'ğŸ‰', trigger: (data) => data.totalMerges >= 1 },
        { id: 'reach_earth', name: 'ì§€êµ¬ ë„ë‹¬', description: 'ì§€êµ¬ê¹Œì§€ ì§„í™”', icon: 'ğŸŒ', trigger: (data) => data.highestPlanet >= 7 },
        { id: 'score_10k', name: '1ë§Œì  ëŒíŒŒ', description: '10,000ì  ë‹¬ì„±', icon: 'ğŸ’', trigger: (data) => data.score >= 10000 },
        { id: 'reach_jupiter', name: 'ëª©ì„± ì •ë³µ', description: 'ëª©ì„±ê¹Œì§€ ì§„í™”', icon: 'ğŸŒ€', trigger: (data) => data.highestPlanet >= 11 },
        { id: 'reach_sun', name: 'íƒœì–‘ ì°½ì¡°ì', description: 'íƒœì–‘ì„ ë§Œë“¦', icon: 'â˜€ï¸', trigger: (data) => data.highestPlanet >= 12 }
    ];

    let gameStats = {
        totalMerges: 0,
        highestPlanet: 0, // planetTypes ë°°ì—´ì˜ ì¸ë±ìŠ¤
        score: 0
    };

    // Tone.js ì‚¬ìš´ë“œ ê´€ë ¨ ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™”
    let dropSynth;
    let mergeSynth;
    let gameOverSynth;
    let isMuted = false; // ì‚¬ìš´ë“œ ìŒì†Œê±° ìƒíƒœ

    // ì‚¬ìš´ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
    function initAudio() {
        // Tone.start()ëŠ” ì‚¬ìš©ì ì œìŠ¤ì²˜(í´ë¦­ ë“±) ì´í›„ì— í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        // ê²Œì„ ì‹œì‘ ì‹œ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì—°ê²°í•©ë‹ˆë‹¤.
        
        dropSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 },
            volume: -10
        }).toDestination();

        mergeSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.02, decay: 0.2, sustain: 0.1, release: 0.3 },
            volume: -8
        }).toDestination();

        gameOverSynth = new Tone.Synth({
            oscillator: { type: "square" },
            envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 1.0 },
            volume: -5
        }).toDestination();

        Tone.Transport.start(); // Tone.TransportëŠ” ì‚¬ìš´ë“œ ì¬ìƒì— í•„ìš”í•˜ë¯€ë¡œ ìœ ì§€
    }

    // ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜ë“¤
    function playDropSound() {
        if (!isMuted) {
            dropSynth.triggerAttackRelease("C5", "16n");
        }
    }

    function playMergeSound() {
        if (!isMuted) {
            mergeSynth.triggerAttackRelease(["E4", "G4", "C5"], "8n");
        }
    }

    function playGameOverSound() {
        if (!isMuted) {
            gameOverSynth.triggerAttackRelease("C2", "1n");
        }
    }

    // ì‚¬ìš´ë“œ ìŒì†Œê±°/í•´ì œ í† ê¸€ í•¨ìˆ˜
    function toggleMute() {
        isMuted = !isMuted;
        if (isMuted) {
            Tone.Destination.mute = true;
            soundToggleButton.textContent = 'ğŸ”‡ ì‚¬ìš´ë“œ ì¼œê¸°';
        } else {
            Tone.Destination.mute = false;
            soundToggleButton.textContent = 'ğŸµ ì‚¬ìš´ë“œ ë„ê¸°';
        }
    }

    // Planet í´ë˜ìŠ¤ ì •ì˜
    class Planet {
        constructor(x, y, type) {
            this.x = x;
            this.y = y;
            this.type = type;

            const proto = planetTypes[type];
            this.size = proto.size;
            this.emoji = proto.emoji;
            this.fontSize = proto.fontSize;
            this.points = proto.points;
            this.color = proto.color;
            
            this.vx = 0;
            this.vy = 0;
            this.merged = false; // í•©ì²´ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
            this.sleeping = false; // ê±°ì˜ ì •ì§€ ìƒíƒœì¸ì§€ ì—¬ë¶€
            this.sleepTimer = 0; // ìˆ˜ë©´ ìƒíƒœ ì§„ì…ì„ ìœ„í•œ íƒ€ì´ë¨¸
            this.onGround = false; // ë°”ë‹¥ì— ë‹¿ì•„ ìˆëŠ”ì§€ ì—¬ë¶€
            this.glowIntensity = 0; // ì¶©ëŒ ì‹œ ê¸€ë¡œìš° íš¨ê³¼ ê°•ë„
            this.pulsePhase = Math.random() * Math.PI * 2; // í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ìœ„ìƒ
        }

        update() {
            if (this.merged || this.sleeping) return;
            
            // ì¤‘ë ¥ ì ìš©
            this.vy += GRAVITY;
            
            // ê³µê¸° ì €í•­ (ì‚¬ìš©ì ì„¤ì •ì— ë”°ë¼ 1.0 ìœ ì§€)
            this.vx *= AIR_RESISTANCE; 
            this.vy *= AIR_RESISTANCE; 
            
            // ë°”ë‹¥ì— ìˆì„ ë•Œ ë§ˆì°° ì ìš©
            if (this.onGround) {
                this.vx *= GROUND_FRICTION;
                // ë°”ë‹¥ì—ì„œ ê±°ì˜ ë©ˆì·„ì„ ë•Œ ì™„ì „íˆ ì •ì§€
                if (Math.abs(this.vx) < MIN_VELOCITY_THRESHOLD) {
                    this.vx = 0;
                }
            }
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            this.x += this.vx;
            this.y += this.vy;
            
            // ê¸€ë¡œìš° íš¨ê³¼ ì—…ë°ì´íŠ¸ (ì ì  ì‚¬ë¼ì§€ê²Œ)
            this.glowIntensity = Math.max(0, this.glowIntensity - 0.02);
            
            // ìˆ˜ë©´ ìƒíƒœ ì²´í¬
            const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
            if (speed < SLEEP_THRESHOLD && this.onGround) {
                this.sleepTimer++;
                if (this.sleepTimer > 30) { // ì¼ì • ì‹œê°„ ì´ìƒ ì •ì§€ ìƒíƒœë©´ ìˆ˜ë©´ ëª¨ë“œ
                    this.sleeping = true;
                    this.vx = 0;
                    this.vy = 0;
                }
            } else {
                this.sleepTimer = 0;
            }
        }

        handleBoundaryCollision() {
            if (this.merged) return;
            
            this.onGround = false; // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ë°”ë‹¥ ìƒíƒœ ì´ˆê¸°í™”
            
            // ë°”ë‹¥ ì¶©ëŒ
            if (this.y + this.size >= canvas.height) {
                this.y = canvas.height - this.size;
                this.onGround = true;
                if (this.vy > MIN_VELOCITY_THRESHOLD) {
                    this.vy *= -BOUNCE_DAMPING; // íŠ•ê¹€ ê°ì‡ 
                    this.glowIntensity = 0.5; // ì¶©ëŒì‹œ ê¸€ë¡œìš°
                } else {
                    this.vy = 0;
                }
            }
            
            // ì²œì¥ ì¶©ëŒ (ê²Œì„ ì˜¤ë²„ ë¼ì¸ ìœ„ìª½ì€ ì¶©ëŒ ì²˜ë¦¬ ì•ˆ í•¨, ê²Œì„ ì˜¤ë²„ ë¡œì§ì´ ë‹´ë‹¹)
            if (this.y - this.size <= 0) {
                this.y = this.size;
                if (this.vy < 0) {
                    this.vy *= -BOUNCE_DAMPING;
                    this.glowIntensity = 0.5;
                }
            }
            
            // ì™¼ìª½ ë²½ ì¶©ëŒ
            if (this.x - this.size < 0) { 
                this.x = this.size;
                if (this.vx < 0) { // ë²½ì„ ëš«ê³  ë“¤ì–´ê°€ë ¤ëŠ” ì†ë„ê°€ ìˆì„ ë•Œë§Œ ë°˜ì‚¬
                    this.vx *= -BOUNCE_DAMPING;
                    this.glowIntensity = 0.5;
                } else { // ëš«ê³  ë“¤ì–´ê°€ë ¤ëŠ” ì†ë„ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë©ˆì¶¤
                    this.vx = 0;
                }
            }
            
            // ì˜¤ë¥¸ìª½ ë²½ ì¶©ëŒ
            if (this.x + this.size > canvas.width) { 
                this.x = canvas.width - this.size;
                if (this.vx > 0) { // ë²½ì„ ëš«ê³  ë“¤ì–´ê°€ë ¤ëŠ” ì†ë„ê°€ ìˆì„ ë•Œë§Œ ë°˜ì‚¬
                    this.vx *= -BOUNCE_DAMPING;
                    this.glowIntensity = 0.5;
                } else { // ëš«ê³  ë“¤ì–´ê°€ë ¤ëŠ” ì†ë„ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë©ˆì¶¤
                    this.vx = 0;
                }
            }
        }
        
        // ë‘ í–‰ì„± ê°„ì˜ ì¶©ëŒ í•´ê²°
        resolveCollision(other) {
            if (this.merged || other.merged) return false;

            const dx = this.x - other.x;
            const dy = this.y - other.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const minDistance = this.size + other.size;

            if (distance < minDistance) { 
                // í•©ì²´ ì²´í¬ - ê°™ì€ íƒ€ì…ì´ë©´ ë°”ë¡œ í•©ì²´
                if (this.type === other.type && this.type < planetTypes.length - 1) {
                    this.merge(other);
                    return true; // í•©ì²´ê°€ ë°œìƒí–ˆìŒì„ ì•Œë¦¼
                }

                // ì¶©ëŒ ì²˜ë¦¬ (ë‹¤ë¥¸ íƒ€ì…ì¼ ë•Œë§Œ)
                // ê²¹ì¹¨ì„ ì™„ì „íˆ ì œê±°í•˜ê¸° ìœ„í•´ ì •í™•í•œ overlap ê°’ ì‚¬ìš©
                // ê²¹ì¹¨ì´ ë°œìƒí•˜ë©´ ìµœì†Œí•œ 1í”½ì…€ ì´ìƒ í™•ì‹¤íˆ ë¶„ë¦¬ë˜ë„ë¡ ì¡°ì •
                const overlap = minDistance - distance + 1.0; 
                const normalX = dx / distance;
                const normalY = dy / distance;
                
                // ìœ„ì¹˜ ë¶„ë¦¬ (50:50ìœ¼ë¡œ ê° í–‰ì„±ì„ ì´ë™)
                const separationX = normalX * overlap * 0.5;
                const separationY = normalY * overlap * 0.5;
                
                this.x += separationX;
                this.y += separationY;
                other.x -= separationX;
                other.y -= separationY;
                
                // ì†ë„ ë°˜ì‚¬ (ê°„ë‹¨í•œ íƒ„ì„± ì¶©ëŒ)
                const relativeVelocityX = this.vx - other.vx;
                const relativeVelocityY = this.vy - other.vy;
                const separationVelocity = relativeVelocityX * normalX + relativeVelocityY * normalY;
                
                // ì´ë¯¸ ë©€ì–´ì§€ê³  ìˆëŠ” ê²½ìš° ì¶©ëŒ ì²˜ë¦¬ ì•ˆ í•¨
                if (separationVelocity > 0) {
                    return false; 
                }
                
                const bounceVelocity = separationVelocity * BOUNCE_DAMPING;
                this.vx -= bounceVelocity * normalX;
                this.vy -= bounceVelocity * normalY;
                other.vx += bounceVelocity * normalX;
                other.vy += bounceVelocity * normalY;
                
                // ì¶©ëŒ ê¸€ë¡œìš° íš¨ê³¼
                this.glowIntensity = Math.max(this.glowIntensity, 0.3);
                other.glowIntensity = Math.max(other.glowIntensity, 0.3);
                
                // ìˆ˜ë©´ ìƒíƒœ í•´ì œ
                this.sleeping = false;
                other.sleeping = false;
                this.sleepTimer = 0;
                other.sleepTimer = 0;
            }
            
            return false; // í•©ì²´ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ìŒì„ ì•Œë¦¼
        }

        // í–‰ì„± í•©ì²´ ë¡œì§
        merge(other) {
            // ì´ë¯¸ í•©ì²´ë˜ì—ˆê±°ë‚˜ ê²Œì„ì´ ì¢…ë£Œëœ ê²½ìš° ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            if (this.type >= planetTypes.length - 1 || !gameRunning) return;
            
            // ë‘ í–‰ì„±ì„ í•©ì²´ ìƒíƒœë¡œ í‘œì‹œ
            this.merged = true;
            other.merged = true;

            const newType = this.type + 1; // ë‹¤ìŒ ë‹¨ê³„ í–‰ì„± íƒ€ì…
            const newX = (this.x + other.x) / 2; // í•©ì²´ë  ìœ„ì¹˜ (ë‘ í–‰ì„±ì˜ ì¤‘ê°„)
            const newY = Math.min(this.y, other.y) - 10; // í•©ì²´ë  ìœ„ì¹˜ (ìœ„ìª½ìœ¼ë¡œ ì•½ê°„ ì´ë™)
            const newPlanet = new Planet(newX, newY, newType); // ìƒˆë¡œìš´ í–‰ì„± ìƒì„±
            
            // ì ìˆ˜ ê³„ì‚° (ì½¤ë³´ ë³´ë„ˆìŠ¤ ì œê±°, ê¸°ë³¸ ì ìˆ˜ë§Œ ì¶”ê°€)
            const bonusPoints = planetTypes[newType].points;
            
            score += bonusPoints;
            gameStats.score = score; // ê²Œì„ í†µê³„ ì ìˆ˜ ì—…ë°ì´íŠ¸
            gameStats.totalMerges++; // ì´ í•©ì²´ íšŸìˆ˜ ì¦ê°€
            gameStats.highestPlanet = Math.max(gameStats.highestPlanet, newType); // ê°€ì¥ ë†’ì€ í–‰ì„± íƒ€ì… ì—…ë°ì´íŠ¸
            
            updateScore(); // ì ìˆ˜ UI ì—…ë°ì´íŠ¸
            
            // ê°•í™”ëœ ë¨¸ì§€ ì´í™íŠ¸ ìƒì„±
            createEnhancedMergeEffect(newX, newY, newType);
            
            // íŒŒì›Œì—… í…ìŠ¤íŠ¸ í‘œì‹œ (íšë“ ì ìˆ˜ í‘œì‹œ)
            showPowerUp(newX, newY, `+${bonusPoints}`);
            
            planets.push(newPlanet); // ìƒˆë¡œìš´ í–‰ì„±ì„ í–‰ì„± ëª©ë¡ì— ì¶”ê°€
            
            // í•©ì²´ ì‚¬ìš´ë“œ ì¬ìƒ
            playMergeSound();
            
            // ì—…ì  ì²´í¬
            checkAchievements();
            
            // ë§ˆì§€ë§‰ í–‰ì„± (íƒœì–‘)ì„ ë§Œë“¤ë©´ ê²Œì„ ì¢…ë£Œ (ìŠ¹ë¦¬)
            if (newType === planetTypes.length - 1) {
                setTimeout(() => endGame(true), 1000); // 1ì´ˆ í›„ ê²Œì„ ìŠ¹ë¦¬ ì²˜ë¦¬
            }
        }

        // í–‰ì„± ê·¸ë¦¬ê¸°
        draw() {
            if (this.merged) return; // í•©ì²´ëœ í–‰ì„±ì€ ê·¸ë¦¬ì§€ ì•ŠìŒ
            
            ctx.save();
            ctx.translate(this.x, this.y);
            
            // ê¸€ë¡œìš° íš¨ê³¼ (ì¶©ëŒ ì‹œ ë˜ëŠ” í° í–‰ì„±)
            if (this.glowIntensity > 0 || this.type >= 7) {
                const glowRadius = this.size + 10;
                const gradient = ctx.createRadialGradient(0, 0, this.size * 0.5, 0, 0, glowRadius);
                const alpha = this.glowIntensity + (this.type >= 7 ? 0.2 : 0); // í° í–‰ì„±ì€ ê¸°ë³¸ ê¸€ë¡œìš°
                gradient.addColorStop(0, `${this.color}00`); // ì¤‘ì‹¬ì€ íˆ¬ëª…
                gradient.addColorStop(1, `${this.color}${Math.floor(alpha * 64).toString(16).padStart(2, '0')}`); // ë°”ê¹¥ì€ ìƒ‰ìƒ + ì•ŒíŒŒ
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, glowRadius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // í–‰ì„± ì´ëª¨ì§€ ê·¸ë¦¬ê¸°
            ctx.font = `${this.fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, 0, 0);
            ctx.restore();
        }
    }
    
    // íŒŒí‹°í´ íš¨ê³¼ ê´€ë¦¬ ë°°ì—´
    let particles = [];
    
    // ê°•í™”ëœ í•©ì²´ ì´í™íŠ¸ ìƒì„± í•¨ìˆ˜
    function createEnhancedMergeEffect(x, y, planetType) {
        const color = planetTypes[planetType].color;
        const particleCount = Math.min(25, 10 + planetType * 2); // í–‰ì„± íƒ€ì…ì— ë”°ë¼ íŒŒí‹°í´ ìˆ˜ ì¦ê°€
        
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 12, // ëœë¤í•œ ì†ë„
                vy: (Math.random() - 0.5) * 12,
                life: 45, maxLife: 45, // íŒŒí‹°í´ ìˆ˜ëª…
                color: color,
                size: Math.random() * 4 + 2, // ëœë¤í•œ í¬ê¸°
                type: 'merge',
                sparkle: Math.random() > 0.7 // ë°˜ì§ì„ íš¨ê³¼ ì—¬ë¶€
            });
        }
        
        // íŠ¹ë³„í•œ íš¨ê³¼ (í° í–‰ì„±ì¼ ë•Œ)
        if (planetType >= 8) { // í•´ì™•ì„± ì´ìƒë¶€í„° ì¶”ê°€ ë³„ íŒŒí‹°í´
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                particles.push({
                    x, y,
                    vx: Math.cos(angle) * 6,
                    vy: Math.sin(angle) * 6,
                    life: 60, maxLife: 60,
                    color: '#ffd700', // í™©ê¸ˆìƒ‰ ë³„
                    size: 6,
                    type: 'star',
                    sparkle: true
                });
            }
        }
    }
    
    // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
    function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.1; // íŒŒí‹°í´ì—ë„ ì•½ê°„ì˜ ì¤‘ë ¥ ì ìš©
            p.life--;
            p.size *= 0.98; // íŒŒí‹°í´ í¬ê¸° ê°ì†Œ

            if (p.life <= 0 || p.size < 0.5) {
                particles.splice(i, 1); // ìˆ˜ëª…ì´ ë‹¤í•˜ê±°ë‚˜ ë„ˆë¬´ ì‘ì•„ì§€ë©´ ì œê±°
            }
        }
    }

    // íŒŒí‹°í´ ê·¸ë¦¬ê¸°
    function drawParticles() {
        particles.forEach(p => {
            ctx.save();
            ctx.globalAlpha = p.life / p.maxLife; // ìˆ˜ëª…ì— ë”°ë¼ íˆ¬ëª…ë„ ì¡°ì ˆ
            ctx.fillStyle = p.color;
            ctx.beginPath();
            if (p.sparkle) {
                // ë°˜ì§ì´ëŠ” ë³„ ëª¨ì–‘
                ctx.moveTo(p.x, p.y - p.size);
                ctx.lineTo(p.x + p.size * 0.6, p.y - p.size * 0.6);
                ctx.lineTo(p.x + p.size, p.y);
                ctx.lineTo(p.x + p.size * 0.6, p.y + p.size * 0.6);
                ctx.lineTo(p.x, p.y + p.size);
                ctx.lineTo(p.x - p.size * 0.6, p.y + p.size * 0.6);
                ctx.lineTo(p.x - p.size, p.y);
                ctx.lineTo(p.x - p.size * 0.6, p.y - p.size * 0.6);
                ctx.closePath();
            } else {
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            }
            ctx.fill();
            ctx.restore();
        });
    }

    // ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateScore() {
        scoreElement.textContent = score;
    }

    // ë‹¤ìŒ í–‰ì„± ì—…ë°ì´íŠ¸
    function updateNextPlanetDisplay() {
        nextPlanetElement.textContent = planetTypes[nextPlanetType].emoji;
    }

    // íŒŒì›Œì—… í…ìŠ¤íŠ¸ í‘œì‹œ (ì ìˆ˜ íšë“ ì‹œ)
    function showPowerUp(x, y, text) {
        const powerUpDiv = document.createElement('div');
        powerUpDiv.className = 'power-up';
        powerUpDiv.textContent = text;
        
        // ìº”ë²„ìŠ¤ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
        const canvasRect = canvas.getBoundingClientRect();
        const scaleX = canvasRect.width / canvas.width;
        const scaleY = canvasRect.height / canvas.height;

        powerUpDiv.style.left = `${canvasRect.left + x * scaleX}px`;
        powerUpDiv.style.top = `${canvasRect.top + y * scaleY}px`;
        powerUpDiv.style.transform = `translate(-50%, -50%)`; // ì¤‘ì•™ ì •ë ¬

        document.body.appendChild(powerUpDiv);

        powerUpDiv.addEventListener('animationend', () => {
            powerUpDiv.remove();
        });
    }

    // ì—…ì  ì²´í¬ ë° í‘œì‹œ
    function checkAchievements() {
        achievementDefinitions.forEach(achievement => {
            if (!achievementsUnlocked[achievement.id] && achievement.trigger(gameStats)) {
                achievementsUnlocked[achievement.id] = true;
                showAchievement(achievement.icon, achievement.name);
                saveAchievements(); // ì—…ì  ì €ì¥
            }
        });
    }

    // ì—…ì  í‘œì‹œ í•¨ìˆ˜
    function showAchievement(icon, text) {
        achievementIcon.textContent = icon;
        achievementText.textContent = text;
        achievementsElement.style.display = 'flex'; // ë³´ì´ê²Œ í•¨
        achievementsElement.style.animation = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
        void achievementsElement.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ
        achievementsElement.style.animation = 'achievementSlide 3s ease-in-out forwards'; // ì• ë‹ˆë©”ì´ì…˜ ë‹¤ì‹œ ì‹œì‘
        
        setTimeout(() => {
            achievementsElement.style.display = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ëë‚œ í›„ ìˆ¨ê¹€
        }, 3000);
    }

    // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ (ë°˜ì‘í˜•)
    function resizeCanvas() {
        const containerWidth = gameContainer.clientWidth;
        const containerHeight = gameContainer.clientHeight;
        
        canvas.width = containerWidth;
        canvas.height = containerHeight;
        
        // í˜„ì¬ ë–¨ì–´ëœ¨ë¦´ í–‰ì„±ì˜ ìœ„ì¹˜ë¥¼ ìº”ë²„ìŠ¤ ì¤‘ì•™ìœ¼ë¡œ ì¡°ì •
        if (currentPlanet) {
            // dropXëŠ” ë§ˆìš°ìŠ¤/í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¼ ì„¤ì •ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” currentPlanet.xë§Œ ì—…ë°ì´íŠ¸
            // currentPlanet.x = canvas.width / 2; // ì´ ì¤„ì€ ì œê±°í•˜ì—¬ ì¤‘ì•™ ê³ ì • ë°©ì§€
        }
    }

    // ë³„ ë°°ê²½ ìƒì„±
    function createStars() {
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) { // ì‘ì€ ë³„
            const star = document.createElement('div');
            star.className = 'star';
            star.style.width = star.style.height = `${Math.random() * 2 + 1}px`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 3}s`;
            starsContainer.appendChild(star);
        }
        for (let i = 0; i < 5; i++) { // ìœ ì„±
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            shootingStar.style.left = `${Math.random() * 100}%`;
            shootingStar.style.top = `${Math.random() * 100}%`;
            shootingStar.style.animationDelay = `${Math.random() * 10}s`;
            starsContainer.appendChild(shootingStar);
        }
    }

    // ê²Œì„ ì´ˆê¸°í™”
    function initGame() {
        score = 0;
        gameRunning = true;
        planets = [];
        gameOverStartTime = null;
        gameStats = { totalMerges: 0, highestPlanet: 0, score: 0 };
        achievementsUnlocked = loadAchievements(); // ì €ì¥ëœ ì—…ì  ë¡œë“œ
        
        generateNextPlanet(); // ì²« í–‰ì„± ìƒì„±
        updateScore();
        updateNextPlanetDisplay();
        gameOverModal.style.display = 'none'; // ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ ìˆ¨ê¹€
        
        resizeCanvas(); // ìº”ë²„ìŠ¤ í¬ê¸° ì´ˆê¸°í™”
        loadRankings(); // ë­í‚¹ ë¡œë“œ
        
        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™” (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”)
        if (Tone.context.state !== 'running') {
            document.body.addEventListener('click', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                    console.log('Audio context started');
                }
            }, { once: true });
        }
    }

    // ë‹¤ìŒ í–‰ì„± ìƒì„±
    function generateNextPlanet() {
        // ì²˜ìŒ 5ê°œ í–‰ì„± ì¤‘ ëœë¤ìœ¼ë¡œ ìƒì„±
        nextPlanetType = Math.floor(Math.random() * 5); 
        // currentPlanetì˜ ì´ˆê¸° x ìœ„ì¹˜ëŠ” ìº”ë²„ìŠ¤ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì • (ë§ˆìš°ìŠ¤ ì´ë™ ì „ê¹Œì§€)
        currentPlanet = new Planet(canvas.width / 2, planetTypes[nextPlanetType].size + 10, nextPlanetType);
        updateNextPlanetDisplay();
    }

    // í–‰ì„± ë–¨ì–´ëœ¨ë¦¬ê¸°
    function dropPlanet() {
        if (!gameRunning || !currentPlanet) return;

        // Tone.js ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³ , ì•„ë‹ˆë©´ ì‹œì‘ ì‹œë„
        if (Tone.context.state !== 'running') {
            Tone.start().then(() => {
                console.log('Audio context started on drop.');
                performDrop();
            }).catch(e => console.error("Failed to start audio context:", e));
        } else {
            performDrop();
        }
    }

    function performDrop() {
        // í˜„ì¬ ë–¨ì–´ëœ¨ë¦´ í–‰ì„±ì„ í–‰ì„± ëª©ë¡ì— ì¶”ê°€í•˜ê³ , ì´ˆê¸° ì†ë„ë¥¼ ì¤Œ
        // dropXëŠ” ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ì— ì˜í•´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ
        currentPlanet.x = dropX; 
        planets.push(currentPlanet);
        playDropSound(); // ë“œë¡­ ì‚¬ìš´ë“œ ì¬ìƒ
        currentPlanet = null; // í˜„ì¬ í–‰ì„± ì´ˆê¸°í™”

        // ë‹¤ìŒ í–‰ì„± ì¤€ë¹„
        generateNextPlanet();
    }

    // ê²Œì„ ì˜¤ë²„ ì¡°ê±´ ì²´í¬ í•¨ìˆ˜
    function checkGameOver() {
        let anyPlanetAboveLine = false;
        // ë¼ì¸ ìœ„ì— ìˆëŠ” ëª¨ë“  í–‰ì„±ì„ ê²€ì‚¬
        for (const planet of planets) {
            // í˜„ì¬ ë–¨ì–´ëœ¨ë¦¬ë ¤ëŠ” í–‰ì„±(currentPlanet)ì€ ì œì™¸í•˜ê³ , ì´ë¯¸ ë–¨ì–´ì§„ í–‰ì„±ë“¤ë§Œ ëŒ€ìƒìœ¼ë¡œ í•¨
            // í–‰ì„±ì´ ê²Œì„ ì˜¤ë²„ ë¼ì¸(gameOverLineY) ìœ„ì— ìˆëŠ”ì§€ í™•ì¸
            if (planet.y - planet.size < gameOverLineY) {
                anyPlanetAboveLine = true;
                break; // í•˜ë‚˜ë¼ë„ ë¼ì¸ ìœ„ì— ìˆìœ¼ë©´ ë” ì´ìƒ ê²€ì‚¬í•  í•„ìš” ì—†ìŒ
            }
        }

        if (anyPlanetAboveLine) {
            // ë¼ì¸ ìœ„ì— í–‰ì„±ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ íƒ€ì´ë¨¸ ì‹œì‘
            if (gameOverStartTime === null) {
                gameOverStartTime = Date.now(); 
            } else if (Date.now() - gameOverStartTime > gameOverDelay) {
                endGame(false); // íƒ€ì´ë¨¸ê°€ ë§Œë£Œë˜ë©´ ê²Œì„ ì˜¤ë²„
            }
        } else {
            // ë¼ì¸ ìœ„ì— í–‰ì„±ì´ ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹
            gameOverStartTime = null;
        }
    }

    // ê²Œì„ ë£¨í”„
    function animate() {
        requestAnimationFrame(animate);

        // Clear canvas for fresh drawing
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw background gradient for the game area (always draw)
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(10, 10, 26, 0.9)');
        gradient.addColorStop(0.3, 'rgba(26, 26, 74, 0.8)');
        gradient.addColorStop(0.7, 'rgba(45, 27, 105, 0.8)');
        gradient.addColorStop(1, 'rgba(74, 14, 94, 0.9)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (!gameRunning) {
            // Game over state: only draw particles and return
            drawParticles();
            return;
        }

        // Draw game over line and warning text (only if game is running)
        const warningIntensity = gameOverStartTime ? 
            Math.sin(Date.now() * 0.01) * 0.5 + 0.5 : 0.3;
        
        ctx.strokeStyle = `rgba(255, 140, 0, ${0.6 + warningIntensity * 0.4})`;
        ctx.lineWidth = gameOverStartTime ? 4 : 2;
        ctx.beginPath();
        ctx.setLineDash([10, 5]);
        ctx.moveTo(0, gameOverLineY);
        ctx.lineTo(canvas.width, gameOverLineY);
        ctx.stroke();
        ctx.setLineDash([]);

        if (gameOverStartTime) {
            // ë‚¨ì€ ì‹œê°„ í‘œì‹œ
            const timeLeft = Math.max(0, gameOverDelay / 1000 - (Date.now() - gameOverStartTime) / 1000);
            ctx.fillStyle = `rgba(255, 140, 0, ${warningIntensity})`;
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`âš ï¸ ${timeLeft.toFixed(1)}ì´ˆ í›„ ê²Œì„ì˜¤ë²„!`, canvas.width / 2, gameOverLineY - 10);
        }

        // Update physics for all planets
        for (let i = 0; i < planets.length; i++) {
            planets[i].update();
            planets[i].handleBoundaryCollision();
        }

        // Iterative Collision Resolution
        let mergesHappenedInIteration;
        for (let k = 0; k < 5; k++) { // Perform several iterations for stability
            mergesHappenedInIteration = false;
            for (let i = 0; i < planets.length; i++) {
                for (let j = i + 1; j < planets.length; j++) {
                    const planet1 = planets[i];
                    const planet2 = planets[j];
                    if (!planet1.merged && !planet2.merged) {
                        if (planet1.resolveCollision(planet2)) {
                            mergesHappenedInIteration = true;
                        }
                    }
                }
            }
            if (mergesHappenedInIteration) {
                planets = planets.filter(p => !p.merged);
                k = -1; // Restart the outer collision loop from 0
            }
        }
        
        // Draw all active planets
        planets.forEach(p => p.draw());

        // Draw the current dropping planet and its guide line
        if (currentPlanet) {
            // currentPlanet.xëŠ” ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë™ì— ë”°ë¼ dropXë¡œ ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨
            
            const guideGradient = ctx.createLinearGradient(dropX, currentPlanet.y, dropX, canvas.height);
            guideGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
            guideGradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
            ctx.strokeStyle = guideGradient;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.moveTo(dropX, currentPlanet.y + currentPlanet.size);
            ctx.lineTo(dropX, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            currentPlanet.draw();
        }
        
        // Update and draw particles
        updateParticles();
        drawParticles();

        // Check game over condition
        checkGameOver();
    }

    // ê²Œì„ ì¢…ë£Œ
    function endGame(win) {
        if (!gameRunning) return;
        gameRunning = false;
        playGameOverSound(); // ê²Œì„ ì˜¤ë²„ ì‚¬ìš´ë“œ ì¬ìƒ
        
        gameOverTitle.textContent = win ? 'ğŸ‰ ê²Œì„ ìŠ¹ë¦¬! ğŸ‰' : 'ğŸ’€ ê²Œì„ ì˜¤ë²„! ğŸ’€';
        finalScore.textContent = score;
        gameOverModal.style.display = 'block'; // ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ í‘œì‹œ
        
        saveRanking(score); // ë­í‚¹ ì €ì¥
        loadRankings(); // ë­í‚¹ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì—…ë°ì´íŠ¸ëœ ëª©ë¡ í‘œì‹œ
    }

    // ê²Œì„ ì¬ì‹œì‘
    function restartGame() {
        initGame();
    }

    // ë­í‚¹ ì €ì¥
    function saveRanking(currentScore) {
        const now = new Date();
        const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        
        rankings.push({ score: currentScore, date: dateString });
        rankings.sort((a, b) => b.score - a.score); // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        rankings = rankings.slice(0, 10); // ìƒìœ„ 10ê°œë§Œ ìœ ì§€

        localStorage.setItem('planetMergeRankings', JSON.stringify(rankings));
    }

    // ë­í‚¹ ë¡œë“œ ë° í‘œì‹œ
    function loadRankings() {
        const savedRankings = localStorage.getItem('planetMergeRankings');
        if (savedRankings) {
            rankings = JSON.parse(savedRankings);
        } else {
            rankings = [];
        }
        displayRankings();
    }

    // ë­í‚¹ UIì— í‘œì‹œ
    function displayRankings() {
        if (rankings.length === 0) {
            rankingContainer.innerHTML = '<div class="no-records">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        let tableHtml = '<table class="ranking-table"><thead><tr><th>ìˆœìœ„</th><th>ì ìˆ˜</th><th>ë‚ ì§œ</th></tr></thead><tbody>';
        rankings.forEach((record, index) => {
            const isNewRecord = (record.score === score && index === 0 && gameRunning === false); // ë°©ê¸ˆ ì„¸ìš´ ìµœê³  ê¸°ë¡ ê°•ì¡°
            tableHtml += `<tr class="${isNewRecord ? 'new-record' : ''}">
                            <td class="rank-number">${index + 1}</td>
                            <td class="rank-score">${record.score}</td>
                            <td class="rank-date">${record.date}</td>
                          </tr>`;
        });
        tableHtml += '</tbody></table>';
        rankingContainer.innerHTML = tableHtml;
    }

    // ë­í‚¹ ì´ˆê¸°í™”
    function clearRankings() {
        // ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œ (ëª¨ë‹¬ ì‚¬ìš©)
        // confirm()ì€ iframeì—ì„œ ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì—†ì´ ë°”ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        localStorage.removeItem('planetMergeRankings');
        rankings = [];
        displayRankings();
    }

    // ì—…ì  ì €ì¥ ë° ë¡œë“œ
    function saveAchievements() {
        localStorage.setItem('planetMergeAchievements', JSON.stringify(achievementsUnlocked));
    }

    function loadAchievements() {
        const saved = localStorage.getItem('planetMergeAchievements');
        return saved ? JSON.parse(saved) : {};
    }

    // ----- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -----
    // ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ ë“œë¡­ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    canvas.addEventListener('mousemove', (e) => {
        if (!gameRunning || !currentPlanet) return;
        const rect = canvas.getBoundingClientRect();
        dropX = e.clientX - rect.left;
        // í–‰ì„±ì´ ìº”ë²„ìŠ¤ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œ
        dropX = Math.max(currentPlanet.size, Math.min(canvas.width - currentPlanet.size, dropX));
    });

    // í„°ì¹˜ ì´ë™ ì‹œ ë“œë¡­ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    canvas.addEventListener('touchmove', (e) => {
        if (!gameRunning || !currentPlanet) return;
        e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
        const rect = canvas.getBoundingClientRect();
        dropX = e.touches[0].clientX - rect.left;
        dropX = Math.max(currentPlanet.size, Math.min(canvas.width - currentPlanet.size, dropX));
    }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•˜ì—¬ preventDefault() ê°€ëŠ¥í•˜ê²Œ í•¨

    // ìº”ë²„ìŠ¤ í´ë¦­/í„°ì¹˜ ì‹œ í–‰ì„± ë–¨ì–´ëœ¨ë¦¬ê¸°
    canvas.addEventListener('mousedown', dropPlanet);
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
        const rect = canvas.getBoundingClientRect();
        dropX = e.touches[0].clientX - rect.left;
        dropX = Math.max(currentPlanet.size, Math.min(canvas.width - currentPlanet.size, dropX));
        dropPlanet();
    }, { passive: false });

    // ìŠ¤í˜ì´ìŠ¤ë°” ëˆŒë €ì„ ë•Œ í–‰ì„± ë–¨ì–´ëœ¨ë¦¬ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && gameRunning) {
            e.preventDefault(); // ìŠ¤í˜ì´ìŠ¤ë°” ê¸°ë³¸ ë™ì‘(ìŠ¤í¬ë¡¤) ë°©ì§€
            dropPlanet();
        }
    });

    // ìœˆë„ìš° í¬ê¸° ë³€ê²½ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ
    window.addEventListener('resize', resizeCanvas);

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
    window.onload = function () {
        createStars(); // ë³„ ë°°ê²½ ìƒì„±
        initAudio(); // ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
        initGame(); // ê²Œì„ ì´ˆê¸°í™”
        animate(); // ê²Œì„ ë£¨í”„ ì‹œì‘
    }
</script>
</body>
</html>